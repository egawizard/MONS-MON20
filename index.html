<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MON-20 Explorer & Minter</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: #0f172a; color: #f1f5f9; font-family: 'Inter', sans-serif; }
    .card { background: #1e293b; border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,.4); }
    .btn { background: linear-gradient(90deg, #6366f1, #06b6d4); padding: 0.7rem 1.5rem; border-radius: 0.7rem; font-weight: bold; color: white; cursor: pointer; transition: 0.3s; }
    .btn:hover { opacity: 0.85; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10">

  <h1 class="text-4xl font-bold mb-6">üöÄ MON-20 Explorer & Minter</h1>

  <!-- Wallet -->
  <div class="card w-96 text-center mb-6">
    <h2 class="text-xl font-semibold mb-2">Wallet</h2>
    <button id="connectBtn" class="btn mb-3">Connect Wallet</button>
    <p id="walletAddr" class="break-all text-sm text-gray-300"></p>
    <p id="walletBal" class="text-lg font-bold"></p>
  </div>

  <!-- Stats -->
  <div class="card w-3/4 mb-6">
    <h2 class="text-2xl font-semibold mb-4">üìä Token Stats</h2>
    <p><b>Total Minted:</b> <span id="totalMinted">0</span></p>
    <p><b>Mint Count:</b> <span id="mintCount">0</span></p>
    <p><b>Last Block:</b> <span id="lastBlock">0</span></p>
    <div class="w-full bg-gray-700 h-4 rounded mt-3">
      <div id="mintProgress" class="bg-gradient-to-r from-indigo-500 to-cyan-400 h-4 rounded" style="width:0%"></div>
    </div>
  </div>

  <!-- Mint -->
  <div class="card w-96 text-center mb-6">
    <h2 class="text-xl font-semibold mb-3">Mint MONS</h2>
    <button id="mintBtn" class="btn">Mint 1000 MONS</button>
    <p id="mintStatus" class="mt-3 text-sm text-gray-300"></p>
  </div>

  <!-- Holders -->
  <div class="card w-3/4">
    <h2 class="text-2xl font-semibold mb-4">üèÜ Top Holders</h2>
    <table class="w-full text-left">
      <thead>
        <tr class="border-b border-gray-600">
          <th class="py-2">Address</th>
          <th class="py-2">Balance</th>
        </tr>
      </thead>
      <tbody id="holdersTable"></tbody>
    </table>
  </div>

<script>
const API = "https://mon20-indexer-backend-production.up.railway.app"; // ganti ke URL Railway kamu
let provider, signer, userAddr;

// -------- Wallet --------
async function connectWallet() {
  if (!window.ethereum) { alert("Install MetaMask!"); return; }
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  userAddr = await signer.getAddress();
  document.getElementById("walletAddr").innerText = userAddr;
  updateBalance();
}
async function updateBalance() {
  if (!provider || !userAddr) return;
  const bal = await provider.getBalance(userAddr);
  document.getElementById("walletBal").innerText =
    "Balance: " + ethers.formatEther(bal) + " MON";
}

// -------- API Fetch --------
async function fetchStats() {
  try {
    const res = await fetch(API + "/stats");
    const s = await res.json();
    document.getElementById("totalMinted").innerText = s.totalMinted;
    document.getElementById("mintCount").innerText  = s.mintCount;
    document.getElementById("lastBlock").innerText  = s.lastBlock;
    document.getElementById("mintProgress").style.width =
      Math.min((s.totalMinted/21000000)*100,100)+"%";
  } catch(e){ console.log("stats err", e); }
}
async function fetchHolders() {
  try {
    const res = await fetch(API + "/holders");
    const h = await res.json();
    const tb = document.getElementById("holdersTable");
    tb.innerHTML = "";
    h.forEach(r => {
      tb.innerHTML += `<tr class="border-b border-gray-700">
        <td class="py-1">${r.address}</td>
        <td class="py-1">${r.balance}</td>
      </tr>`;
    });
  } catch(e){ console.log("holders err", e); }
}

// -------- Mint (self-transfer with JSON data) --------
async function mint() {
  if (!signer) return alert("Connect wallet dulu");
  try {
    const tx = {
      to: userAddr,
      value: 0,
      data: ethers.hexlify(ethers.toUtf8Bytes(JSON.stringify({
        p: "MON-20",
        op: "mint",
        tick: "MONS",
        amt: "1000"
      })))
    };
    const sent = await signer.sendTransaction(tx);
    document.getElementById("mintStatus").innerText = "‚è≥ Tx sent: " + sent.hash;
    await sent.wait();
    document.getElementById("mintStatus").innerText = "‚úÖ Mint success!";
    fetchStats(); fetchHolders();
  } catch(e) {
    console.log(e);
    document.getElementById("mintStatus").innerText = "‚ùå " + e.message;
  }
}

// -------- Auto Refresh --------
setInterval(()=>{ fetchStats(); fetchHolders(); if(userAddr) updateBalance(); }, 8000);

// -------- Bind Buttons --------
document.getElementById("connectBtn").onclick = connectWallet;
document.getElementById("mintBtn").onclick = mint;

// Init
fetchStats(); fetchHolders();
</script>
</body>
</html>
